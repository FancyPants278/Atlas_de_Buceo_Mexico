---
title: "Atlas de Buceo de México"
resource_files:
- "shp/Diving_sites_v1.0_01032021/dive_sites.shx"
- "shp/Diving_sites_v1.0_01032021/dive_sites.prj"
- "shp/Diving_sites_v1.0_01032021/dive_sites.dbf"
- "shp/Diving_sites_v1.0_01032021/dive_sites.cpg"
- "shp/Tourism_operators_v1.0_01032021/operators.cpg"
- "shp/Tourism_operators_v1.0_01032021/operators.dbf"
- "shp/Tourism_operators_v1.0_01032021/operators.prj"
- "shp/Tourism_operators_v1.0_01032021/operators.qpj"
- "shp/Tourism_operators_v1.0_01032021/operators.shx"
- "shp/MPA_MX_v1.0_01032021/MPA_MX_c1-0.shx" 
- "shp/MPA_MX_v1.0_01032021/MPA_MX_c1-0.prj" 
- "shp/MPA_MX_v1.0_01032021/MPA_MX_c1-0.dbf" 

runtime: shiny
output:
        flexdashboard::flex_dashboard:
        source_code: embed
        theme: united
---
        
Atlas de Buceo de México
=======================================================================
        
```{r setup, include=FALSE}

library(flexdashboard)
library(leaflet)
library(mapview)
library(rgdal)
library(sf)
library(tidyverse)
library(ggthemes)
library(viridis)
library(rnaturalearth)
library(hrbrthemes)
library(patchwork)


# Loading diving site data and diving operators data ----------------

ds <- raster::shapefile("shp/Diving_sites_v1.0_01032021/dive_sites.shp", verbose = FALSE)
to <- raster::shapefile("shp/Tourism_operators_v1.0_01032021/operators.shp",encoding = "latin1", verbose = FALSE)

# Loading MPA layer -------------------
mpa <- raster::shapefile("shp/MPA_MX_v1.0_01032021/MPA_MX_c1-0.shp", encoding = "UTF-8", verbose = FALSE)



```


```{r}




to$labels1 <- paste0(
  "<h3 style= 'background-color:tomato; color: black; text-align: center; font-size: 130%; font-family:verdana'> Operador </h3>", 
                     "<b style= 'color:#263270'> Región: </b> ", to$region, "<br/> ",
                     "<b style= 'color:#263270'> Estado: </b> ", to$state, "<br/> ",
                     "<b style= 'color:#263270'> Nombre: </b> ", to$company_na, "<br/> ",
                     "<b style= 'color:#263270'> Latitud: </b> ", to$lat, "<br/> ",
                     "<b style= 'color:#263270'> Longitud: </b> ", to$long, "<br/> ",
                     "<b style= 'color:#263270'> Dirección: </b> ", to$address, "<br/> ",
                     "<b style= 'color:#263270'> Telefono: </b> ", to$phone, "<br/> ",
                     "<b style= 'color:#263270'> Correo: </b> ", to$email, "<br/> ") %>%
        lapply(htmltools::HTML)

ds$labels2 <- paste0(
  "<h3 style= 'background-color:powderblue; color: black; text-align: center; font-size: 130%; font-family:verdana'> Sitio de Buceo </h3>", 
                     "<b style= 'color:#263270'> Nombre: </b> ", ds$site_name, "<br/> ",
                     "<b style= 'color:#263270'> Región: </b> ", ds$region, "<br/> ",
                     "<b style= 'color:#263270'> Localidad: </b> ", ds$locality, "<br/> ",
                     "<b style= 'color:#263270'> Estado: </b> ", ds$state, "<br/> ",
                     "<b style= 'color:#263270'> Popularidad: </b> ", ds$popularity, "<br/> ",
                     "<b style= 'color:#263270'> Latitud: </b> ", ds$latitude, "<br/> ",
                     "<b style= 'color:#263270'> Longitud: </b> ", ds$longitude, "<br/> ") %>%
        lapply(htmltools::HTML)


mpa$labels3 <- paste0("<h3 style= 'background-color:#14c794; color: black; text-align: center; font-size: 130%; font-family:verdana'> AMP </h3>", 
                      "<b style= 'color:#263270'> Nombre: </b> ", mpa$ANP, "<br/> ",
                      "<b style= 'color:#263270'>Plan de Manejo: </b> ", "<a href =\"", mpa$PM_link, "\", target=\"_blank\"> PDF </a>" ,   "<br/> ",
                      "<b style= 'color:#263270'>Fecha: </b> ", mpa$FECHA, "<br/> ",
                      "<b style= 'color:#263270'> Zona: </b> ", mpa$Categor, "<br/> ",
                      "<b style= 'color:#263270'> Subzona </b> ", mpa$Subznfc, "<br/> ",
                      "<b style= 'color:#263270'> Buceo: </b> ", mpa$Buceo, "<br/> ",
                      "<b style= 'color:#263270'> Pesca: </b> ", mpa$Pesca, "<br/> ") %>%
        lapply(htmltools::HTML)

#Create Diving Sites' marker
diverIcon <- makeIcon(
  iconUrl = "icons/Media/diver.png",
  iconWidth = 30, iconHeight = 30,
  iconAnchorX = 0, iconAnchorY = 0 
)
#Create Operators' marker
operIcon <- makeIcon(
    iconUrl = "icons/Media/sotre.png",
  iconWidth = 40, iconHeight = 40,
  iconAnchorX = 0, iconAnchorY = 0 
)


icons <- awesomeIcons(
        icon = 'flag-outline',
        iconColor = 'black',
        library = 'ion')


leaflet(to) %>%
        addProviderTiles(providers$Esri.WorldImagery, group = "Satélite") %>%
        addProviderTiles(providers$Esri.WorldTopoMap, group = "Mapa") %>%
        addProviderTiles(providers$Esri.OceanBasemap, group = "Océano") %>%

        setView(lat =  21.601093,
                lng = -100.739661,
                zoom = 5) %>%
        addMarkers(
                popup = ~ labels1,
                group = "Operadores",
                icon = operIcon
        ) %>%
        addPolygons(
                data = mpa,
                group = "AMPs",
                weight = 2,
                opacity = 1,

                fillColor = "magma",
                fillOpacity = 0.3,
                color = "#bf0a0a",
                dashArray = "2",
                highlightOptions = highlightOptions(
                        color = "#06d611",
                        weight = 2,
                        bringToFront = TRUE
                ),
                popup = ~ labels3, 
        ) %>%
        addMarkers(
                icon=diverIcon,#Add diving flag as marker
                clusterOptions = markerClusterOptions(),
                data = ds, 
                group = "Sitios de Buceo",
                popup = ~ labels2
        ) %>% 
        # Layers control
        addLayersControl(
                baseGroups = c("Satélite", "Mapa", "Ocean"),
                overlayGroups = c("Operadores", "AMPs", "Sitios de Buceo"),
                options = layersControlOptions(collapsed = TRUE)
        ) %>%
        hideGroup(c("Operadores", "Sitios de Buceo")) %>%
        setView(lat =  21.601093,
                lng = -100.739661,
                zoom = 5) %>% 


    addMiniMap(
  position = "bottomright",
  width = 140,
  height = 140,
  collapsedWidth = 19,
  collapsedHeight = 19,
  zoomLevelOffset = -5,
  zoomLevelFixed = FALSE,
  centerFixed = FALSE,
  zoomAnimation = TRUE,
  toggleDisplay = TRUE,
  autoToggleDisplay = FALSE,
  minimized = FALSE,
  aimingRectOptions = list(color = "#ff7800", weight = 1, clickable = FALSE),
  shadowRectOptions = list(color = "#000000", weight = 1, clickable = FALSE, opacity =
    0, fillOpacity = 0),
  strings = list(hideText = "Hide MiniMap", showText = "Show MiniMap"),
  tiles = NULL,
  mapOptions = list()
)


```

Pesca
=======================================================================
```{r, include=FALSE}
mpa_layer <- st_read("shp/old/final_mpa_layer.shp")


mpa_metadata <- read.csv("shp/old/MPA_metadata.csv", na.strings = "")

mpa_layer <- mpa_layer %>% 
        select(ANP, ID, nombre_1)

final_mpa <- merge(mpa_layer, mpa_metadata, by = c("ID", "ANP"))

final_mpa$Pesca <- replace_na(final_mpa$Pesca, "NA")

final_mpa$Pesca <- factor(final_mpa$Pesca, levels = c("NA", "ND", "NO", "SI"), labels = c("Sin manejo", "No especificado", "Prohibida", "Permitida"))

final_mpa$Buceo <- replace_na(final_mpa$Buceo, "NA")

final_mpa$Buceo <- factor(final_mpa$Buceo, levels = c("NA", "ND", "NO", "SI"), labels = c("Sin manejo", "No especificado", "Prohibido", "Permitido"))


dive_sites <- st_read('shp/dive_sites.shp')



test <- st_join(dive_sites, final_mpa)

test <- test %>% 
        mutate(protection_level = ifelse(is.na(ANP), "Sin Protección", "Into MPA"), 
               core_zone = ifelse(Pesca == "Prohibida", "Pesca Prohibida", "Amortiguamiento"),
               protection_level = ifelse(is.na(core_zone), "Sin Protección", core_zone)) %>% 
        select(-core_zone) %>% 
        mutate(protection_level = factor(protection_level, levels = c("Sin Protección", "Amortiguamiento", "Pesca Prohibida"))) 

```


Column 
-------------------------------------
###
<h1 style= 'background-color: powderblue; color: white; text-align: center; font-size: 180%; font-family:verdana'> Pesca </h1>

```{r}
leaflet(to) %>% 
        addProviderTiles(providers$Esri.WorldImagery, group = "Satélite") %>%
        addProviderTiles(providers$Esri.WorldTopoMap, group = "Mapa") %>%
        addProviderTiles(providers$Esri.OceanBasemap, group = "Océano") %>%
          setView(lat =  21.601093,
                lng = -100.739661,
                zoom = 5) %>%
 
        addPolygons(
                data = mpa,
                group = "AMPs",
                weight = 2,
                opacity = 1,

                fillColor = "magma",
                fillOpacity = 0.3,
                color = "#bf0a0a",
                dashArray = "2",
                highlightOptions = highlightOptions(
                        color = "#06d611",
                        weight = 2,
                        bringToFront = TRUE
                ),
                popup = ~ labels3, 
        ) %>%
        
        # Layers control
        addLayersControl(
                baseGroups = c("Satélite", "Mapa", "Ocean"),
                overlayGroups = "AMPs",
                options = layersControlOptions(collapsed = TRUE)
        ) 

```
Column {.tabset}
-------------------------------------

### Subzonas en AMP

```{r graph_1, fig.height=5, fig.width=7}

renderPlot({mpa %>%
         as.data.frame() %>% 
         select(ANP, Pesca, Buceo) %>% 
         group_by(Pesca) %>% 
         count() %>% 
         mutate(Pesca = factor(Pesca, levels = c("No especificado", "Sin manejo", "Prohibida", "Permitida"))) %>% 
         ggplot(aes(x= reorder(Pesca, n), y = n,  fill = Pesca)) +
         geom_col() +
         scale_fill_manual(values = c("#edb72f", "gray30", "#c91818", "#07ab4b"), name = "Nivel de Protección") +
         theme_ipsum() +
         labs(x = "", y = "Número de subzonas en AMP") +
         theme(strip.text.x = element_text(angle = 0, hjust = -.5),
               strip.text.y = element_text(angle = 0, vjust = -.5),
               axis.text.x = element_blank(), 
               axis.title.y=element_text(face="bold", vjust =.5, family="verdana", size=18),
               legend.position = "bottom",
               legend.text=element_text(size=20, colour="black", family="verdana"),
               legend.title = element_text(face="bold", size = 25,family="verdana"))})



```   
 
### 
<h3> Sitios de Pesca </h3>
```{r graph_2, fig.height=5, fig.width=7}
renderPlot({
  test %>%
                as.data.frame() %>% 
                select(ANP, Pesca, Buceo) %>% 
                group_by(Pesca) %>% 
                count() %>% 
                filter(!is.na(Pesca)) %>% 
                mutate(Pesca = factor(Pesca, levels = c("No especificado", "Sin manejo", "Prohibida", "Permitida"))) %>% 
                ggplot(aes(x= reorder(Pesca, n), y = n,  fill = Pesca)) +
                geom_col() +
                scale_fill_manual(values = c( "#fee391", "gray30","firebrick", "#005a32"), name = "Nivel de Protección") +
                theme_ipsum() +
                labs(x = "", y = "Número de sitios de buceo") +
                theme(strip.text.x = element_text(angle = 0, hjust = .5),
                      axis.text.x = element_blank(),
                      strip.text.y = element_text(angle = 0, vjust = -.5),
                      axis.title.y = element_text(
                                    face = "bold",
                                    vjust = .5,
                                    family = "verdana",
                                    size = 18),
                      legend.position = "bottom",
                      legend.text=element_text(size=20, colour="black", family="verdana"),
                      legend.title = element_text(face="bold", size = 25,family="verdana"))})

```


Buceo
=======================================================================
Column 
-------------------------------------
### Buceo

```{r}
leaflet(to) %>% 
        addProviderTiles(providers$Esri.WorldImagery, group = "Satélite") %>%
        addProviderTiles(providers$Esri.WorldTopoMap, group = "Mapa") %>%
        addProviderTiles(providers$Esri.OceanBasemap, group = "Océano") %>%
          setView(lat =  21.601093,
                lng = -100.739661,
                zoom = 5) %>%
 
        addPolygons(
                data = mpa,
                group = "AMPs",
                weight = 2,
                opacity = 1,

                fillColor = "magma",
                fillOpacity = 0.3,
                color = "#bf0a0a",
                dashArray = "2",
                highlightOptions = highlightOptions(
                        color = "#06d611",
                        weight = 2,
                        bringToFront = TRUE
                ),
                popup = ~ labels3, 
        ) %>%
        
        # Layers control
        addLayersControl(
                baseGroups = c("Satélite", "Mapa", "Ocean"),
                overlayGroups = "AMPs",
                options = layersControlOptions(collapsed = TRUE)
        ) 

```
Column {.tabset}
-------------------------------------

### Subzonas en AMP

```{r graph_3, fig.height=5, fig.width=7}

renderPlot({mpa %>%
         as.data.frame() %>% 
         select(ANP, Pesca, Buceo) %>% 
         group_by(Buceo) %>% 
         count() %>% 
         mutate(Buceo = factor(Buceo, levels = c("No especificado", "Sin manejo", "Prohibido", "Permitido"))) %>% 
         ggplot(aes(x= reorder(Buceo, n), y = n,  fill = Buceo)) +
         geom_col() +
         scale_fill_manual(values = c("#edb72f", "gray30", "#c91818", "#07ab4b"), name = "Nivel de Protección") +
         theme_ipsum() +
         labs(x = "", y = "Número de subzonas en AMP") +
         theme(strip.text.x = element_text(angle = 0, hjust = -.5),
               strip.text.y = element_text(angle = 0, vjust = -.5),
               axis.text.x = element_blank(), 
               axis.title.y=element_text(face="bold", vjust =.5, family="verdana", size=18),
               legend.position = "bottom",
               legend.text=element_text(size=20, colour="black", family="verdana"),
               legend.title = element_text(face="bold", size = 25,family="verdana"))})



```   
 
### Sitios de Buceo
```{r graph_4, fig.height=5, fig.width=7}
renderPlot({
  test %>%
                as.data.frame() %>% 
                select(ANP, Buceo, Buceo) %>% 
                group_by(Buceo) %>% 
                count() %>% 
                filter(!is.na(Buceo)) %>% 
                mutate(Buceo = factor(Buceo, levels = c("No especificado", "Sin manejo", "Prohibido", "Permitido"))) %>% 
                ggplot(aes(x= reorder(Buceo, n), y = n,  fill = Buceo)) +
                geom_col() +
                scale_fill_manual(values = c( "#fee391", "gray30","firebrick", "#005a32"), name = "Nivel de Protección") +
                theme_ipsum() +
                labs(x = "", y = "Número de sitios de buceo") +
                theme(strip.text.x = element_text(angle = 0, hjust = .5),
                      axis.text.x = element_blank(),
                      strip.text.y = element_text(angle = 0, vjust = -.5),
                      axis.title.y = element_text(
                                    face = "bold",
                                    vjust = .5,
                                    family = "verdana",
                                    size = 18),
                      legend.position = "bottom",
                      legend.text=element_text(size=20, colour="black", family="verdana"),
                      legend.title = element_text(face="bold", size = 25,family="verdana"))})

```


Credits
=======================================================================
        
### About the project

This work is part of the diving atlas initiative in Mexico, a project where international institutions are collaborating: the Scripps Institution of Oceanography (USA), the Gulf of California Marina Program (USA), the Centro para la Biodiversidad Marina y la Conservación, A.C. (México), the Universidad Autónoma de Baja California Sur (México), the Senckenberg Institute (Germany). 

### Data sources

- Mexican MPA layer is currently under development, original data from: http://sig.conanp.gob.mx/website/pagsig/info_shape.htm


### Dashboard, data creation and supervision: 

- Dr. Fabio Favoretto (UABCS-CBMC);

### Data creation:

- Joy Kumagai (Senckenberg);
- Terrance Wang (NOAA);
- Norman Blanco Lupio (CBMC);
- Eduardo León Solórzano (UABCS);
- Eduardo Peláez Torres (UABCS);

### Project supervision: 

- Marisol Placencia de la Cruz (CBMC); 
- Octavio Aburto Oropeza (SIO); 
- Catalina López Sagastégui (UC-Mexus);






